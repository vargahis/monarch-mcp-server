name: Build and Release MCP Bundle

on:
  push:
    tags:
      - 'v*'
  release:
    types: [created]

permissions:
  contents: write

jobs:
  build-mcpb:
    runs-on: ubuntu-latest
    if: startsWith(github.ref_name, 'v')
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install mcpb CLI
        run: npm install -g @anthropic-ai/mcpb

      - name: Inject version from git tag
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          jq --arg v "$VERSION" '.version = $v' manifest.json > manifest.tmp && mv manifest.tmp manifest.json

      - name: Validate manifest
        run: mcpb validate .

      - name: Pack bundle
        run: mcpb pack . monarch-mcp-${{ github.ref_name }}.mcpb

      - name: Detect pre-release
        id: prerelease
        run: |
          TAG="${GITHUB_REF_NAME}"
          if [[ "$TAG" =~ (dev|a|alpha|b|beta)[0-9]+$ ]]; then
            echo "is_prerelease=true" >> "$GITHUB_OUTPUT"
          else
            echo "is_prerelease=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b  # v2
        with:
          tag_name: ${{ github.ref_name }}
          files: monarch-mcp-${{ github.ref_name }}.mcpb
          generate_release_notes: true
          prerelease: ${{ steps.prerelease.outputs.is_prerelease == 'true' }}
